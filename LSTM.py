import tensorflow as tf
from sklearn.metrics import r2_score,mean_squared_error
from sklearn.preprocessing import MinMaxScaler
import pandas
import numpy as np


# variables
set = 500 # train model with 500 days
day = 30 # predict days
time_step = 100 # to predict next day so you have to give previous days 

hidden_layer = 50
dense_layer = 1
epochs = 30
batch_size = 64
verbose = 1

all_r2 = []
all_msError = []


######################### Functions #############################

def create_train_set(data, time_step): # for training
    x_data, y_data = [], []

    for i in range(len(data)-time_step-1):
        a = data[i:(i+time_step), 0]
        x_data.append(a)
        y_data.append(data[i+time_step, 0])

    return np.array(x_data), np.array(y_data)

def create_test_set(all_data, set_data, time_step, days): # for test
    x_test, y_test = [], []
    for i in range(days):
        x = all_data[set_data.shape[0] - time_step + i: set_data.shape[0] + i] # 450 - 500
        y = all_data[set_data.shape[0]+i] # 501
        x_test.append(x)
        y_test.append(y)

    return np.array(x_test),np.array(y_test)


def cal_step(total_set, set, days): # Calculate steps
    return int((total_set-set)/days)

#######################################################################################


#     READ DATA
#####################

data = pandas.read_csv('AAPL.csv')["Close"]


#     NORMALIZING
######################

scaler = MinMaxScaler(feature_range=(0, 1))
close_values = scaler.fit_transform(np.array(data).reshape(data.shape[0], 1))


#     BUILDING RNN MODEL
#############################

model = tf.keras.Sequential([
    tf.keras.layers.LSTM(hidden_layer,return_sequences=True,input_shape=(time_step,1)),
    tf.keras.layers.LSTM(hidden_layer,return_sequences=True),
    tf.keras.layers.LSTM(hidden_layer),
    tf.keras.layers.Dense(dense_layer)
])

#     COMPILING THE MODEL
################################

model.compile(optimizer='adam',loss='mean_squared_error')




steps = cal_step(len(close_values),set,day) # total steps
# print(steps)


#        MAIN FUNCTION 
# The model is train every time when the loop starts so it take time to complete all iteration
################################

def Main():

    iterated = 0

    for i in range(steps):
        last_index = set + iterated  # 500 + 0

        close_value = close_values[iterated:last_index]  # 0-500

        x_train ,y_train = create_train_set(close_value,time_step)
        x_test , y_test = create_test_set(close_values,close_value,time_step,day)

        iterated += day  # add for next iteration 

        # reshaping
        x_train = x_train.reshape(x_train.shape[0],x_train.shape[1],1)
        y_train = y_train.reshape(y_train.shape[0],1)

        x_test = x_test.reshape(x_test.shape[0],x_test.shape[1],1)
        y_test = y_test.reshape(y_test.shape[0],1)

        # print(x_train.shape,y_train.shape)
        # print(x_test.shape,y_test.shape)

        # Training the model
        model.fit(x_train,y_train,epochs=epochs,batch_size=batch_size,verbose=verbose)

        # Prediction
        y_predict = model.predict(x_test)

        # inverse normalizing
        y_predict = scaler.inverse_transform(y_predict)
        y_test = scaler.inverse_transform(y_test)

        r2 = r2_score(y_test,y_predict) # r2
        mean_err = mean_squared_error(y_test,y_predict) # mean square error

        all_r2.append(r2)
        all_msError.append(mean_err)
        # print(y_predict,y_test)

        print(r2)
        print(mean_err)

Main()
print("all r2: ", all_r2)
print("all Error: ", all_msError)




"""
WHEN EPOCH == 30 , time_step = 50


all r2:  [0.35439323641102616, -0.922684304267636, 0.5928271620109772, 0.712399526432967, -0.34980721032579876, 0.4561150262172956, 0.7279265593766792, 0.833289614696494, 0.8763943876096212, 0.9082982805858164, 0.684432074638593, 0.9066883551015185, 0.9207169516379752, 0.9144338410872812, 0.9289161978448965, 0.9202430353593197, 0.9164018074131351, 0.5339467001412996, 0.9010056227119667, 0.9217150057916944, 0.8952566836342135, 0.7640329279258262, 0.87634701374337, 0.6165163110062064, 0.7048409822973969, 0.8765168046879412, 0.8790599108422616, 0.8275348800950189, 0.897744381135409, 0.9199565227605166, 0.6836636505357128, 0.8339009126910275, 0.8830389869229711, 0.909555808466432, 0.9058218892377944, 0.6426836874532915, 0.8946060613106336, 0.032152823816138154, 0.9197578352999789, -0.09361746076765898, 0.8471230428182602, 0.8947756388591762, 0.9192875085399403, -0.687939864947837, 0.9198623877902276, 0.8183852367487783, 0.9012553031839262, -2.8345915772296606, 0.5352285250157951, 0.9208984202991138, 0.9123391755302908, 0.7951952016702146, 0.8464099113434858, 0.1525866153323019, 0.7211691262587577, 0.5550340857639354, 0.8995239606674515, 0.7574066940325137, 0.7630106871213527, 0.7653604898666059, 0.22690049902881926, 0.8197110267319334, 0.08462599144610428, 0.6284686895592402, -2.4101079330974695, 0.024569795340179335, 0.6806456714575145, -1.139993762095255, -7.125026350429476, -8.926488010604348, -0.9706297836748066, -0.3994140876142689, 0.4480477183499143, -6.838507240847812, -13.937636055178167, -15.702303606814155, -17.81228592909155, -14.036455332603715, -26.02421683924311, -26.049845778407608, -25.917657981969374, -73.43721341261516, -56.26510572102876, -67.44286128211733, -93.23027026989546, -92.35839747604048, -122.18266294033845, -159.07974969698145, -185.65580858017788, -174.0518944386169, -155.01886285692123, -123.96106642215199, -142.51344778643775, -124.1075334350437, -125.99765982798083]


all mean square Error:  [0.35231567493938576, 1.0492328404178208, 0.2221993035444986, 0.1569471707427241, 0.7366066546458113, 0.29680482367071076, 0.14847387492258807, 0.09097593958139398, 0.06745312659601788, 0.05004277369850973, 0.17220935851859873, 0.05092133014430875, 0.043265749788058416, 0.04669452169571438, 0.03879131871901713, 0.04352437182084365, 0.045620577890514956, 0.25433110704209205, 0.05402246819031518, 0.04272109917002754, 0.057159736053037764, 0.12877017861326365, 0.06747897910656155, 0.2092718390449052, 0.16107196268864296, 0.0673863220673096, 0.06599851727384505, 0.09411637013380146, 0.05580216845367361, 0.04368072532473942, 0.1726286971496579, 0.09064234663026699, 0.06382708575535051, 0.04935652502671568, 0.05139417138886584, 0.19499197487015937, 0.0575147887817118, 0.5281662930850056, 0.043789151553690606, 0.5968007083351371, 0.08342686506682083, 0.05742224819533808, 0.04404581474133116, 0.9211298677700986, 0.04373209595383324, 0.09910944479284839, 0.05388621443809515, 2.0925845202400306, 0.2536315991972526, 0.04316672007301334, 0.04783760685390081, 0.11176453659385961, 0.0838160298200818, 0.4624440687581551, 0.1521614905797777, 0.24282345731264166, 0.05483102967493081, 0.13238619721482048, 0.1293280281887182, 0.12804571148006708, 0.4218900541961666, 0.09838594463906045, 0.4995310300853, 0.20274927677552337, 1.8609384935599638, 0.5323044464412999, 0.17427564602915463, 1.167821325890988, 4.433928366299328, 5.417008495685965, 1.0753972874005726, 0.7636777472043298, 0.3012072543398692, 4.27757130939036, 8.15165457611213, 9.114655700886722, 10.266099409206678, 8.205581490120375, 14.747452679240888, 14.761438711465095, 14.689302179837092, 40.621317128531565, 31.250283470425682, 37.35012429755739, 51.42263548371839, 50.946843609852785, 67.22231779821676, 87.35751890995705, 101.86040619479856, 95.5280053073049, 85.14144223821519, 68.19281479165997, 78.31708103347486, 68.27274367006335, 69.30420925159859]


when time_step = 100

all r2:  [0.22607328290003081, 0.2999518947512092, 0.8745456668207489, 0.7120708342427844, 0.669462306068916, 0.8857676164903211, 0.6590358445295099, 0.9049643029720625, 0.7687817364496445, 0.9132780029708077, 0.8938805644224583, 0.9255557423516141, 0.9174428193858057, 0.8576273310302281, 0.889092295575022, 0.9275213111025675, 0.9200403506591202, 0.9230163603910615, 0.9197213755884431, 0.8206495974296899, 0.9150480110395897, 0.9167255135332799, 0.9118886663440157, 0.7727910837100999, 0.918463578950824, 0.9063399041320324, 0.9177329703873739, 0.8949122180804141, 0.8586984919802072, 0.8229579482633107, 0.8798025920859216, 0.9113191327181422, 0.9207765887077932, 0.851982878732664, 0.9165237911388927, 0.7524865071595346, 0.865295780129985, 0.8878632265068073, 0.9208759259473751, 0.9141148144884345, 0.6703092744427055, 0.9189692939569436, 0.9012096770748595, 0.8563596608691868, 0.8492673850235647, 0.9179432617353656, 0.8322037063670159, 0.8412566132160918, 0.9106504265891477, 0.9050300064116779, 0.9006462532193705, 0.8182239122563015, 0.847051729191977, 0.7628829258070087, 0.7476067490232547, 0.8252678075664456, 0.8433456406807291, 0.3298514451912694, 0.7359952631783055, 0.9142262560537759, 0.7331393014030159, -0.21432549821047098, -2.5534951939252215, 0.5618859594577723, 0.5343047972622411, -2.185319061535184, -1.2044969039191495, -3.3742625034755127, -0.3324967715433267, -0.6038709034034206, -0.5875055450546423, 0.5136758271668314, -4.273699312542706, -4.083250857252805, -6.2531271426265995, -7.022479174455302, -16.040917720458225, -16.332846600738936, -20.450941340837723, -34.14352476493109, -43.43897365348352, -38.67664123283855, -34.41942733300178, -47.643555544925015, -181.76147890929906, -259.86387113129405, -242.01817973697976, -174.25127581156548, -193.49414716563842, -180.49056700983905, -164.2015745532596, -219.09234019803304, -247.2763333124844, -329.63301858425484, -333.202446208517]



all Error:  [0.4223414763701145, 0.3820249950909563, 0.06846199662223196, 0.15712654217648625, 0.18037854820922894, 0.06233803851808752, 0.18606839850457696, 0.0518621669258866, 0.12617869448610514, 0.04732527699304466, 0.05791070149551757, 0.04062516125597878, 0.04505248465411118, 0.07769454378415, 0.06052371961415955, 0.039552525837349854, 0.043634979393406416, 0.04201093371038655, 0.043809048073681224, 0.09787375488593549, 0.046359361481357005, 0.04544392741745172, 0.048083455344004274, 0.12399074360671665, 0.04449544340952908, 0.05111148419073683, 0.044894145628380504, 0.05734771520834517, 0.07710999787424869, 0.09661405900322359, 0.06559322684260747, 0.04839425695748926, 0.04323320509415291, 0.08077479190581555, 0.04555400984771288, 0.13507120464774314, 0.07350977532648992, 0.06119443795655731, 0.04317899552172623, 0.046868618495554994, 0.17991634698846545, 0.04421946841397985, 0.053911113175712684, 0.07838632722505605, 0.0822566707411557, 0.04477938701310557, 0.0915685333204923, 0.08662824897624999, 0.048759178244656524, 0.051826311738209764, 0.05421858061118387, 0.09919748158344092, 0.08346578180343724, 0.1293977491337777, 0.13773414961406777, 0.09535353992985605, 0.085488240595484, 0.36570843695096045, 0.1440706824746759, 0.046807803441370394, 0.1456292164882738, 0.6626725920896699, 1.9391867127939266, 0.2390843042535507, 0.2541356889703281, 1.738268398589041, 1.2030214960705317, 2.387089685533683, 0.7271601319835638, 0.8752523853792371, 0.8663216049143262, 0.26539317562066284, 2.87792358679309, 2.773993485916169, 3.95812207801243, 4.377967091489216, 9.299441652213067, 9.458750888564063, 11.706046625920893, 19.17826042973193, 24.250902994424614, 21.652038707845588, 19.328823907330843, 26.545395850549994, 99.73522185068649, 142.35667283596663, 132.6180561377831, 95.63681021292611, 106.13788546683749, 99.04166935263396, 90.15256270895571, 120.1071391427152, 135.48749622169814, 180.43056806313126, 182.37844930216644]
"""